<!DOCTYPE html>
<html>
<head>
    <title>Мы - Чат</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            background-color: #f5f5f5;
            padding: 10px;
            max-width: 100%;
            margin: 0 auto;
        }

        #login-screen, #chat-screen {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 0 auto;
            width: 100%;
            max-width: 600px;
        }

        h1, h2 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5rem;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        button {
            width: 100%;
            padding: 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        #messages {
            height: 50vh;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #fafafa;
        }

        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            background-color: #f0f0f0;
            word-wrap: break-word;
            max-width: 100%;
        }

        .my-message {
            background-color: #e3f2fd;
            border-left: 4px solid #2196F3;
        }

        .other-message {
            background-color: #f1f8e9;
            border-left: 4px solid #8BC34A;
        }

        .message strong {
            color: #333;
            display: block;
            margin-bottom: 5px;
        }

        .message-time {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
            display: block;
        }

        #message-input-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        #message-input {
            flex: 1;
            margin-bottom: 0;
        }

        #send-button {
            width: auto;
            min-width: 100px;
        }

        /* Для мобильных устройств */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            #login-screen, #chat-screen {
                padding: 15px;
                border-radius: 8px;
            }

            h1, h2 {
                font-size: 1.3rem;
            }

            #messages {
                height: 60vh;
                min-height: 250px;
                padding: 10px;
            }

            .message {
                padding: 8px;
            }

            button, input[type="text"] {
                padding: 10px;
            }

            #message-input-container {
                flex-direction: column;
                gap: 5px;
            }

            #send-button {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            h1, h2 {
                font-size: 1.1rem;
            }

            #messages {
                height: 65vh;
                font-size: 14px;
            }

            .message-time {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <div id="login-screen">
        <h1>Мы - Общий чат</h1>
        <input type="text" id="user-name" placeholder="Введите ваше имя">
        <button onclick="startChat()">Войти в чат</button>
    </div>

    <div id="chat-screen" style="display: none;">
        <h2>Чат "Мы"</h2>
        <div id="messages"></div>
        <div id="message-input-container">
            <input type="text" id="message-input" placeholder="Введите сообщение">
            <button id="send-button" onclick="sendMessage()">Отправить</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script>
        // Firebase конфигурация
        const firebaseConfig = {
            apiKey: "AIzaSyBx_47h2PDtDNKyJspTU3sAexICynyIbAU",
            authDomain: "chatnash-4d8bd.firebaseapp.com",
            databaseURL: "https://chatnash-4d8bd-default-rtdb.firebaseio.com",
            projectId: "chatnash-4d8bd",
            storageBucket: "chatnash-4d8bd.firebasestorage.app",
            messagingSenderId: "790700361393",
            appId: "1:790700361393:web:69a5db26291e862fcb8490"
        };

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        let userName = '';
        let userId = '';

        // Загружаем userId из localStorage или создаем новый
        function getOrCreateUserId() {
            userId = localStorage.getItem('chatUserId');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('chatUserId', userId);
            }
            return userId;
        }

        function startChat() {
            const nameInput = document.getElementById('user-name');
            userName = nameInput.value.trim();
            
            if (!userName) {
                alert('Введите имя');
                return;
            }

            // Сохраняем имя в localStorage для удобства
            localStorage.setItem('chatUserName', userName);
            
            // Получаем или создаем userId
            getOrCreateUserId();

            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'block';
            
            loadMessages();
            document.getElementById('message-input').focus();
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (!text || !userName) return;

            const messagesRef = database.ref('messages');
            
            const messageData = {
                text: text,
                userName: userName,
                userId: userId,
                timestamp: Date.now(),
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            };
            
            messagesRef.push(messageData).then(() => {
                input.value = '';
                input.focus();
            }).catch((error) => {
                console.error('Ошибка отправки:', error);
                alert('Ошибка отправки сообщения');
            });
        }

        function loadMessages() {
            const messagesRef = database.ref('messages');
            
            messagesRef.on('child_added', (snapshot) => {
                const message = snapshot.val();
                displayMessage(message);
                
                // Автопрокрутка к последнему сообщению
                const messagesDiv = document.getElementById('messages');
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
            
            // Очистка старых сообщений (опционально, чтобы не перегружать чат)
            cleanupOldMessages();
        }

        function cleanupOldMessages() {
            // Удаляем сообщения старше 24 часов
            const messagesRef = database.ref('messages');
            const cutoffTime = Date.now() - (24 * 60 * 60 * 1000);
            
            messagesRef.orderByChild('timestamp').endAt(cutoffTime).once('value', (snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    childSnapshot.ref.remove();
                });
            });
        }

        function displayMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            
            const isMyMessage = message.userId === userId;
            
            messageDiv.className = isMyMessage ? 'message my-message' : 'message other-message';
            
            const senderText = isMyMessage ? 'Вы' : message.userName;
            const time = message.time || new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageDiv.innerHTML = `
                <strong>${senderText}</strong>
                <div>${message.text}</div>
                <span class="message-time">${time}</span>
            `;
            
            messagesDiv.appendChild(messageDiv);
        }

        // Обработчики клавиш
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        document.getElementById('user-name').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                startChat();
            }
        });

        // При загрузке страницы проверяем, есть ли сохраненное имя
        window.addEventListener('DOMContentLoaded', () => {
            const savedName = localStorage.getItem('chatUserName');
            if (savedName) {
                document.getElementById('user-name').value = savedName;
            }
            
            // Создаем userId сразу при загрузке
            getOrCreateUserId();
        });
    </script>
</body>
</html>